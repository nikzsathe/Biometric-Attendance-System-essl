{% extends "base.html" %}

{% block title %}Holidays Management - {{ COMPANY_NAME }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-calendar-day me-2"></i>Holidays Management
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-primary" onclick="showAddHolidayModal()">
                    <i class="fas fa-plus me-1"></i>Add Holiday
                </button>
            </div>
        </div>
    </div>

    <!-- Holidays Table -->
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for holiday in holidays %}
                <tr data-holiday-id="{{ holiday.id }}">
                    <td>
                        <span class="badge bg-primary">{{ holiday.date }}</span>
                    </td>
                    <td>{{ holiday.name }}</td>
                    <td>{{ holiday.description or 'No description' }}</td>
                    <td>
                        {% if holiday.is_public_holiday %}
                        <span class="badge bg-success">Public Holiday</span>
                        {% else %}
                        <span class="badge bg-warning">Company Holiday</span>
                        {% endif %}
                    </td>
                    <td>
                        <small class="text-muted">{{ holiday.created_date }}</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showEditHolidayModal({{ holiday.id }})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteHoliday({{ holiday.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Add/Edit Holiday Modal -->
    <div class="modal fade" id="holidayModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="holidayModalTitle">Add New Holiday</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="holidayForm">
                        <input type="hidden" id="holidayId">
                        <div class="mb-3">
                            <label for="holidayDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="holidayDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="holidayName" class="form-label">Holiday Name</label>
                            <input type="text" class="form-control" id="holidayName" placeholder="e.g., Republic Day" required>
                        </div>
                        <div class="mb-3">
                            <label for="holidayDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="holidayDescription" rows="3" placeholder="Optional description"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isPublicHoliday" checked>
                                <label class="form-check-label" for="isPublicHoliday">
                                    Public Holiday (affects all employees)
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveHoliday()">Save Holiday</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let isEditMode = false;

function showAddHolidayModal() {
    isEditMode = false;
    document.getElementById('holidayModalTitle').textContent = 'Add New Holiday';
    document.getElementById('holidayForm').reset();
    document.getElementById('holidayId').value = '';
    document.getElementById('holidayDate').value = new Date().toISOString().split('T')[0];
    
    const modal = new bootstrap.Modal(document.getElementById('holidayModal'));
    modal.show();
}

function showEditHolidayModal(holidayId) {
    isEditMode = true;
    document.getElementById('holidayModalTitle').textContent = 'Edit Holiday';
    
    // Get holiday data from the row
    const row = document.querySelector(`tr[data-holiday-id="${holidayId}"]`);
    const date = row.cells[0].textContent.trim();
    const name = row.cells[1].textContent.trim();
    const description = row.cells[2].textContent.trim();
    const isPublic = row.cells[3].textContent.includes('Public Holiday');
    
    // Populate form
    document.getElementById('holidayId').value = holidayId;
    document.getElementById('holidayDate').value = date;
    document.getElementById('holidayName').value = name;
    document.getElementById('holidayDescription').value = description === 'No description' ? '' : description;
    document.getElementById('isPublicHoliday').checked = isPublic;
    
    const modal = new bootstrap.Modal(document.getElementById('holidayModal'));
    modal.show();
}

function saveHoliday() {
    const holidayId = document.getElementById('holidayId').value;
    const date = document.getElementById('holidayDate').value;
    const name = document.getElementById('holidayName').value;
    const description = document.getElementById('holidayDescription').value;
    const isPublicHoliday = document.getElementById('isPublicHoliday').checked;
    
    if (!date || !name) {
        showAlert('danger', 'Please fill in all required fields');
        return;
    }
    
    const data = {
        date: date,
        name: name,
        description: description,
        is_public_holiday: isPublicHoliday
    };
    
    const url = isEditMode ? `/api/holidays/${holidayId}` : '/api/holidays';
    const method = isEditMode ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById('holidayModal'));
            modal.hide();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error saving holiday');
        console.error('Error:', error);
    });
}

function deleteHoliday(holidayId) {
    if (!confirm('Are you sure you want to delete this holiday?')) {
        return;
    }
    
    fetch(`/api/holidays/${holidayId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Remove row from table
            const row = document.querySelector(`tr[data-holiday-id="${holidayId}"]`);
            row.remove();
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error deleting holiday');
        console.error('Error:', error);
    });
}

// Initialize date picker with current date
document.addEventListener('DOMContentLoaded', function() {
    if (!document.getElementById('holidayId').value) {
        document.getElementById('holidayDate').value = new Date().toISOString().split('T')[0];
    }
});
</script>
{% endblock %}


