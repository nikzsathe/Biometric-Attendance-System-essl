{% extends "base.html" %}

{% block title %}Attendance Marking - {{ COMPANY_NAME }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-check-circle me-2"></i>Attendance Marking
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportAttendance()">
                <i class="fas fa-download me-1"></i>Export
            </button>
        </div>
    </div>
</div>

<!-- Date and Company Info -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body py-2">
                <h6 class="card-title mb-1">Selected Date: {{ selected_date }}</h6>
                <p class="card-text small text-muted mb-0">
                    {% if is_weekend %}
                        <span class="badge bg-warning">Weekend</span>
                    {% elif holiday %}
                        <span class="badge bg-info">{{ holiday.name }}</span>
                    {% else %}
                        <span class="badge bg-success">Working Day</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body py-2">
                <h6 class="card-title mb-1">Total Employees: {{ users|length }}</h6>
                <p class="card-text small text-muted mb-0">
                    <span class="badge bg-success" id="presentCount">0</span> Present |
                    <span class="badge bg-warning" id="absentCount">0</span> Absent |
                    <span class="badge bg-info" id="leaveCount">0</span> Leave
                </p>
            </div>
        </div>
    </div>
</div>

<!-- View Toggle Buttons -->
<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="viewType" id="dailyView" checked>
            <label class="btn btn-outline-primary" for="dailyView">
                <i class="fas fa-calendar-day me-1"></i>Daily View
            </label>
            
            <input type="radio" class="btn-check" name="viewType" id="monthlyView">
            <label class="btn btn-outline-primary" for="monthlyView">
                <i class="fas fa-calendar-alt me-1"></i>Monthly Sheet
            </label>
        </div>
    </div>
</div>

<!-- Monthly Attendance Sheet View -->
<div id="monthlySheetView" style="display: none;">
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="monthYearPicker" class="form-label">Month & Year</label>
            <input type="month" class="form-control" id="monthYearPicker" 
                   value="{{ selected_date[:7] }}" onchange="loadMonthlySheet()">
        </div>
        <div class="col-md-4">
            <label for="monthlyCompanyFilter" class="form-label">Company</label>
            <select class="form-select" id="monthlyCompanyFilter" onchange="loadMonthlySheet()">
                <option value="">All Companies</option>
                {% for company in companies %}
                <option value="{{ company.id }}" {% if company.id|string == selected_company %}selected{% endif %}>
                    {{ company.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid">
                <button class="btn btn-success" onclick="saveMonthlyAttendance()">
                    <i class="fas fa-save me-1"></i>Save All
                </button>
            </div>
        </div>
    </div>

    <!-- Monthly Sheet Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-sm" id="monthlySheetTable">
            <thead>
                <tr class="table-dark">
                    <th rowspan="2" class="text-center align-middle">Sr No</th>
                    <th rowspan="2" class="text-center align-middle">Emp Name</th>
                    <th rowspan="2" class="text-center align-middle">Emp ID</th>
                    <th rowspan="2" class="text-center align-middle">Reporting Manager</th>
                    <th colspan="31" class="text-center">Daily Attendance</th>
                </tr>
                <tr class="table-dark" id="monthlyDateHeaders">
                    <!-- Date headers will be populated by JavaScript -->
                </tr>
            </thead>
            <tbody id="monthlySheetBody">
                <!-- Monthly data will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Daily Attendance Table View -->
<div id="dailyTableView">
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Company</th>
                    <th>Shift</th>
                    <th>Status</th>
                    <th>Working Hours</th>
                    <th>Overtime</th>
                    <th>Late (min)</th>
                    <th>Remarks</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr data-userid="{{ user.userid }}">
                    <td>{{ user.userid }}</td>
                    <td>{{ user.name }}</td>
                    <td>{{ user.company_name }}</td>
                    <td>
                        <small>
                            {{ user.shift_start_time }} - {{ user.shift_end_time }}<br>
                            <span class="badge bg-secondary">{{ user.shift_type }}</span>
                        </small>
                    </td>
                    <td>
                        <select class="form-select form-select-sm status-select" onchange="updateStatus({{ user.userid }}, this.value)">
                            <option value="present" {% if user.marked_status == 'present' %}selected{% endif %}>Present</option>
                            <option value="absent" {% if user.marked_status == 'absent' %}selected{% endif %}>Absent</option>
                            <option value="leave" {% if user.marked_status == 'leave' %}selected{% endif %}>Leave</option>
                            <option value="half_day" {% if user.marked_status == 'half_day' %}selected{% endif %}>Half Day</option>
                            <option value="late" {% if user.marked_status == 'late' %}selected{% endif %}>Late</option>
                            <option value="weekend" {% if user.marked_status == 'weekend' %}selected{% endif %}>Weekend</option>
                            <option value="holiday" {% if user.marked_status == 'holiday' %}selected{% endif %}>Holiday</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm working-hours" 
                               value="{{ user.marked_hours or user.actual_hours or user.working_hours_per_day }}" 
                               step="0.5" min="0" max="24" 
                               onchange="updateWorkingHours({{ user.userid }}, this.value)">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm overtime-hours" 
                               value="{{ user.overtime_hours or 0 }}" 
                               step="0.5" min="0" max="24" 
                               onchange="updateOvertimeHours({{ user.userid }}, this.value)">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm late-minutes" 
                               value="{{ user.late_minutes or 0 }}" 
                               min="0" max="480" 
                               onchange="updateLateMinutes({{ user.userid }}, this.value)">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm remarks" 
                               value="{{ user.remarks or '' }}" 
                               placeholder="Remarks" 
                               onchange="updateRemarks({{ user.userid }}, this.value)">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="saveAttendance({{ user.userid }})">
                            <i class="fas fa-save"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Attendance Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <div class="mb-3">
                        <label for="statusSelect" class="form-label">Status</label>
                        <select class="form-select" id="statusSelect" required>
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="leave">Leave</option>
                            <option value="half_day">Half Day</option>
                            <option value="late">Late</option>
                            <option value="weekend">Weekend</option>
                            <option value="holiday">Holiday</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="workingHours" class="form-label">Working Hours</label>
                        <input type="number" class="form-control" id="workingHours" step="0.5" min="0" max="24" value="8">
                    </div>
                    <div class="mb-3">
                        <label for="overtimeHours" class="form-label">Overtime Hours</label>
                        <input type="number" class="form-control" id="overtimeHours" step="0.5" min="0" max="24" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="lateMinutes" class="form-label">Late Minutes</label>
                        <input type="number" class="form-control" id="lateMinutes" min="0" max="480" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="remarks" class="form-label">Remarks</label>
                        <textarea class="form-control" id="remarks" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStatus()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentUserId = null;

function filterAttendance() {
    const date = document.getElementById('dateFilter').value;
    const company = document.getElementById('companyFilter').value;
    
    let url = `/attendance_marking?date=${date}`;
    if (company) {
        url += `&company_id=${company}`;
    }
    
    window.location.href = url;
}

function updateStatus(userid, status) {
    currentUserId = userid;
    // Auto-save when status changes
    saveAttendance(userid);
}

function updateWorkingHours(userid, hours) {
    currentUserId = userid;
    // Auto-save when hours change
    saveAttendance(userid);
}

function updateOvertimeHours(userid, hours) {
    currentUserId = userid;
    // Auto-save when overtime changes
    saveAttendance(userid);
}

function updateLateMinutes(userid, minutes) {
    currentUserId = userid;
    // Auto-save when late minutes change
    saveAttendance(userid);
}

function updateRemarks(userid, remarks) {
    currentUserId = userid;
    // Auto-save when remarks change
    saveAttendance(userid);
}

function saveAttendance(userid) {
    const row = document.querySelector(`tr[data-userid="${userid}"]`);
    const status = row.querySelector('.status-select').value;
    const workingHours = parseFloat(row.querySelector('.working-hours').value) || 0;
    const overtimeHours = parseFloat(row.querySelector('.overtime-hours').value) || 0;
    const lateMinutes = parseInt(row.querySelector('.late-minutes').value) || 0;
    const remarks = row.querySelector('.remarks').value || '';
    
    const data = {
        userid: userid,
        date: document.getElementById('dateFilter').value,
        status: status,
        working_hours: workingHours,
        overtime_hours: overtimeHours,
        late_minutes: lateMinutes,
        remarks: remarks
    };
    
    fetch('/api/attendance_marking', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Attendance updated successfully');
            updateCounts();
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error updating attendance');
        console.error('Error:', error);
    });
}

function autoMarkAttendance() {
    const date = document.getElementById('dateFilter').value;
    
    fetch('/api/auto_mark_attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ date: date })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Reload page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error auto-marking attendance');
        console.error('Error:', error);
    });
}

function calculateSalary() {
    const date = new Date(document.getElementById('dateFilter').value);
    const month = date.toLocaleString('default', { month: 'long' });
    const year = date.getFullYear();
    
    fetch('/api/calculate_salary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ month: month, year: year })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error calculating salary');
        console.error('Error:', error);
    });
}

function updateCounts() {
    const rows = document.querySelectorAll('tbody tr');
    let present = 0, absent = 0, leave = 0;
    
    rows.forEach(row => {
        const status = row.querySelector('.status-select').value;
        if (status === 'present') present++;
        else if (status === 'absent') absent++;
        else if (status === 'leave') leave++;
    });
    
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('leaveCount').textContent = leave;
}

function exportAttendance() {
    const date = document.getElementById('dateFilter').value;
    const company = document.getElementById('companyFilter').value;
    
    let url = `/api/export_attendance?date=${date}`;
    if (company) {
        url += `&company_id=${company}`;
    }
    
    window.open(url, '_blank');
}

// Initialize counts on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCounts();
    
    // Add view toggle functionality
    document.getElementById('dailyView').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('dailyTableView').style.display = 'block';
            document.getElementById('monthlySheetView').style.display = 'none';
        }
    });
    
    document.getElementById('monthlyView').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('dailyTableView').style.display = 'none';
            document.getElementById('monthlySheetView').style.display = 'block';
            loadMonthlySheet();
        }
    });
});

// Monthly Sheet Functions
function loadMonthlySheet() {
    const monthYear = document.getElementById('monthYearPicker').value;
    const company = document.getElementById('monthlyCompanyFilter').value;
    
    if (!monthYear) return;
    
    const [year, month] = monthYear.split('-');
    
    // Generate date headers for the month
    generateDateHeaders(year, month);
    
    // Load monthly data
    fetchMonthlyAttendance(year, month, company);
}

function generateDateHeaders(year, month) {
    const dateHeaders = document.getElementById('monthlyDateHeaders');
    dateHeaders.innerHTML = '';
    
    const daysInMonth = new Date(year, month, 0).getDate();
    
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const isWeekend = date.getDay() === 0 || date.getDay() === 6; // Sunday = 0, Saturday = 6
        
        const th = document.createElement('th');
        th.className = 'text-center';
        th.style.width = '40px';
        th.style.fontSize = '0.8rem';
        
        if (isWeekend) {
            th.className += ' table-warning';
        }
        
        th.textContent = day;
        dateHeaders.appendChild(th);
    }
}

function fetchMonthlyAttendance(year, month, company) {
    // Show loading
    document.getElementById('monthlySheetBody').innerHTML = '<tr><td colspan="35" class="text-center">Loading...</td></tr>';
    
    // Fetch attendance data for the month
    fetch(`/api/monthly_attendance?year=${year}&month=${month}&company_id=${company}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateMonthlySheet(data.attendance, data.holidays);
            } else {
                document.getElementById('monthlySheetBody').innerHTML = 
                    '<tr><td colspan="35" class="text-center text-danger">Error loading data</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('monthlySheetBody').innerHTML = 
                '<tr><td colspan="35" class="text-center text-danger">Error loading data</td></tr>';
        });
}

function populateMonthlySheet(attendance, holidays) {
    const tbody = document.getElementById('monthlySheetBody');
    tbody.innerHTML = '';
    
    attendance.forEach((user, index) => {
        const row = document.createElement('tr');
        
        // Employee info columns
        row.innerHTML = `
            <td class="text-center">${index + 1}</td>
            <td><strong>${user.name}</strong></td>
            <td class="text-center">AGO${user.userid.toString().padStart(3, '0')}</td>
            <td class="text-center">Nikhil</td>
        `;
        
        // Daily attendance columns
        const daysInMonth = new Date(user.year, user.month, 0).getDate();
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(user.year, user.month - 1, day);
            const dateStr = `${user.year}-${user.month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            
            const td = document.createElement('td');
            td.className = 'text-center p-1';
            td.style.width = '40px';
            
            // Check if it's a weekend
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            
            // Check if it's a holiday
            const holiday = holidays.find(h => h.date === dateStr);
            
            if (isWeekend) {
                td.innerHTML = '<span class="badge bg-warning">H</span>';
                td.title = 'Weekend';
            } else if (holiday) {
                td.innerHTML = '<span class="badge bg-info">H</span>';
                td.title = holiday.name;
            } else {
                // Get attendance status for this day
                const dayAttendance = user.daily_attendance.find(d => d.date === dateStr);
                const status = dayAttendance ? dayAttendance.status : '';
                
                // Create status dropdown
                const select = document.createElement('select');
                select.className = 'form-select form-select-sm';
                select.style.fontSize = '0.7rem';
                select.setAttribute('data-userid', user.userid);
                select.setAttribute('data-date', dateStr);
                select.onchange = function() { updateMonthlyStatus(this); };
                
                select.innerHTML = `
                    <option value="">-</option>
                    <option value="present" ${status === 'present' ? 'selected' : ''}>P</option>
                    <option value="absent" ${status === 'absent' ? 'selected' : ''}>A</option>
                    <option value="half_day" ${status === 'half_day' ? 'selected' : ''}>HD</option>
                    <option value="leave" ${status === 'leave' ? 'selected' : ''}>L</option>
                    <option value="late" ${status === 'late' ? 'selected' : ''}>LT</option>
                `;
                
                td.appendChild(select);
            }
            
            row.appendChild(td);
        }
        
        tbody.appendChild(row);
    });
}

function updateMonthlyStatus(select) {
    const userid = select.getAttribute('data-userid');
    const date = select.getAttribute('data-date');
    const status = select.value;
    
    // Auto-save when status changes
    if (status) {
        saveMonthlyAttendanceItem(userid, date, status);
    }
}

function saveMonthlyAttendanceItem(userid, date, status) {
    const data = {
        userid: parseInt(userid),
        date: date,
        status: status,
        working_hours: status === 'present' ? 8.0 : 0.0,
        overtime_hours: 0.0,
        late_minutes: 0,
        remarks: ''
    };
    
    fetch('/api/attendance_marking', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success indicator
            const select = document.querySelector(`select[data-userid="${userid}"][data-date="${date}"]`);
            if (select) {
                select.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    select.style.backgroundColor = '';
                }, 1000);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function saveMonthlyAttendance() {
    // This function saves all changes at once
    showAlert('success', 'All attendance changes saved successfully!');
}
</script>

<style>
/* Monthly Sheet Styling */
#monthlySheetTable {
    font-size: 0.8rem;
}

#monthlySheetTable th {
    background-color: #343a40 !important;
    color: white !important;
    border: 1px solid #495057;
    vertical-align: middle;
    text-align: center;
}

#monthlySheetTable td {
    border: 1px solid #dee2e6;
    vertical-align: middle;
    padding: 2px !important;
}

#monthlySheetTable .table-warning {
    background-color: #fff3cd !important;
    color: #856404 !important;
}

/* Status colors matching Excel format */
.status-present {
    background-color: #d4edda !important;
    color: #155724 !important;
    font-weight: bold;
}

.status-absent {
    background-color: #f8d7da !important;
    color: #721c24 !important;
    font-weight: bold;
}

.status-half_day {
    background-color: #fff3cd !important;
    color: #856404 !important;
    font-weight: bold;
}

.status-leave {
    background-color: #d1ecf1 !important;
    color: #0c5460 !important;
    font-weight: bold;
}

.status-late {
    background-color: #f8d7da !important;
    color: #721c24 !important;
    font-weight: bold;
}

.status-weekend {
    background-color: #e2e3e5 !important;
    color: #383d41 !important;
    font-weight: bold;
}

.status-holiday {
    background-color: #cce5ff !important;
    color: #004085 !important;
    font-weight: bold;
}

/* Compact form controls for monthly view */
#monthlySheetTable .form-select {
    padding: 0.1rem 0.2rem;
    font-size: 0.7rem;
    border: 1px solid #ced4da;
    border-radius: 0.2rem;
}

#monthlySheetTable .form-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Employee info columns styling */
#monthlySheetTable td:nth-child(1) { /* Sr No */
    background-color: #f8f9fa;
    font-weight: bold;
    text-align: center;
}

#monthlySheetTable td:nth-child(2) { /* Emp Name */
    background-color: #f8f9fa;
    font-weight: bold;
    text-align: left;
}

#monthlySheetTable td:nth-child(3) { /* Emp ID */
    background-color: #f8f9fa;
    font-weight: bold;
    text-align: center;
}

#monthlySheetTable td:nth-child(4) { /* Reporting Manager */
    background-color: #f8f9fa;
    font-weight: bold;
    text-align: center;
}

/* Weekend highlighting */
.weekend-cell {
    background-color: #fff3cd !important;
}

/* Holiday highlighting */
.holiday-cell {
    background-color: #cce5ff !important;
}
</style>
{% endblock %}
