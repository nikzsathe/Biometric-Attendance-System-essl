{% extends "base.html" %}

{% block title %}Salary Calculation - {{ COMPANY_NAME }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-money-bill-wave me-2"></i>Salary Calculation
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-success" onclick="calculateSalary()">
                    <i class="fas fa-calculator me-1"></i>Calculate Salary
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportSalary()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-md-3">
            <label for="monthFilter" class="form-label">Month</label>
            <select class="form-select" id="monthFilter" onchange="filterSalary()">
                <option value="January" {% if selected_month == 'January' %}selected{% endif %}>January</option>
                <option value="February" {% if selected_month == 'February' %}selected{% endif %}>February</option>
                <option value="March" {% if selected_month == 'March' %}selected{% endif %}>March</option>
                <option value="April" {% if selected_month == 'April' %}selected{% endif %}>April</option>
                <option value="May" {% if selected_month == 'May' %}selected{% endif %}>May</option>
                <option value="June" {% if selected_month == 'June' %}selected{% endif %}>June</option>
                <option value="July" {% if selected_month == 'July' %}selected{% endif %}>July</option>
                <option value="August" {% if selected_month == 'August' %}selected{% endif %}>August</option>
                <option value="September" {% if selected_month == 'September' %}selected{% endif %}>September</option>
                <option value="October" {% if selected_month == 'October' %}selected{% endif %}>October</option>
                <option value="November" {% if selected_month == 'November' %}selected{% endif %}>November</option>
                <option value="December" {% if selected_month == 'December' %}selected{% endif %}>December</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="yearFilter" class="form-label">Year</label>
            <select class="form-select" id="yearFilter" onchange="filterSalary()">
                {% for year in range(2024, 2027) %}
                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="companyFilter" class="form-label">Company</label>
            <select class="form-select" id="companyFilter" onchange="filterSalary()">
                <option value="">All Companies</option>
                {% for company in companies %}
                <option value="{{ company.id }}" {% if company.id|string == selected_company %}selected{% endif %}>
                    {{ company.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid">
                <button type="button" class="btn btn-primary" onclick="filterSalary()">
                    <i class="fas fa-filter me-1"></i>Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body py-2">
                    <h6 class="card-title mb-1">Total Employees</h6>
                    <h4 class="mb-0">{{ users|length }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body py-2">
                    <h6 class="card-title mb-1">Total Salary</h6>
                    <h4 class="mb-0" id="totalSalary">₹0</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body py-2">
                    <h6 class="card-title mb-1">Total Overtime</h6>
                    <h4 class="mb-0" id="totalOvertime">₹0</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body py-2">
                    <h6 class="card-title mb-1">Total Deductions</h6>
                    <h4 class="mb-0" id="totalDeductions">₹0</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Salary Table -->
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Company</th>
                                            <th>Monthly Salary</th>
                    <th>Attendance</th>
                    <th>Working Hours</th>
                    <th>Overtime</th>
                    <th>Basic Salary</th>
                    <th>Overtime Pay</th>
                    <th>Deductions</th>
                    <th>Net Salary</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr data-userid="{{ user.userid }}">
                    <td>{{ user.userid }}</td>
                    <td>{{ user.name }}</td>
                    <td>{{ user.company_name }}</td>
                                            <td>₹{{ user.monthly_salary }}</td>
                    <td>
                        {% if user.present_days and user.total_days %}
                        <div class="progress" style="height: 20px;">
                            {% set attendance_percent = (user.present_days / user.total_days * 100) | round %}
                            <div class="progress-bar {% if attendance_percent >= 80 %}bg-success{% elif attendance_percent >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ attendance_percent }}%">
                                {{ user.present_days }}/{{ user.total_days }}
                            </div>
                        </div>
                        {% else %}
                        <span class="text-muted">Not calculated</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.total_working_hours %}
                        <span class="badge bg-info">{{ user.total_working_hours }}h</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.overtime_hours %}
                        <span class="badge bg-warning">{{ user.overtime_hours }}h</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.basic_salary %}
                        <span class="text-success">₹{{ "%.2f"|format(user.basic_salary) }}</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.overtime_pay %}
                        <span class="text-warning">₹{{ "%.2f"|format(user.overtime_pay) }}</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.deductions %}
                        <span class="text-danger">₹{{ "%.2f"|format(user.deductions) }}</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.net_salary %}
                        <strong class="text-primary">₹{{ "%.2f"|format(user.net_salary) }}</strong>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewSalaryDetails({{ user.userid }})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="recalculateUserSalary({{ user.userid }})">
                            <i class="fas fa-calculator"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Salary Details Modal -->
<div class="modal fade" id="salaryDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Salary Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="salaryDetailsContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printSalary()">
                    <i class="fas fa-print me-1"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function filterSalary() {
    const month = document.getElementById('monthFilter').value;
    const year = document.getElementById('yearFilter').value;
    const company = document.getElementById('companyFilter').value;
    
    let url = `/salary?month=${month}&year=${year}`;
    if (company) {
        url += `&company_id=${company}`;
    }
    
    window.location.href = url;
}

function calculateSalary() {
    const month = document.getElementById('monthFilter').value;
    const year = document.getElementById('yearFilter').value;
    
    if (!month || !year) {
        showAlert('danger', 'Please select month and year');
        return;
    }
    
    showAlert('info', 'Calculating salary... This may take a moment.');
    
    fetch('/api/calculate_salary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ month: month, year: year })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Reload page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error calculating salary');
        console.error('Error:', error);
    });
}

function recalculateUserSalary(userid) {
    const month = document.getElementById('monthFilter').value;
    const year = document.getElementById('yearFilter').value;
    
    showAlert('info', 'Recalculating salary for user...');
    
    fetch('/api/calculate_salary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ month: month, year: year, userid: userid })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Salary recalculated successfully');
            // Reload page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error recalculating salary');
        console.error('Error:', error);
    });
}

function viewSalaryDetails(userid) {
    const month = document.getElementById('monthFilter').value;
    const year = document.getElementById('yearFilter').value;
    
    // Get user data from the row
    const row = document.querySelector(`tr[data-userid="${userid}"]`);
    const name = row.cells[1].textContent.trim();
    const company = row.cells[2].textContent.trim();
    const hourlyRate = row.cells[3].textContent.trim();
    
    // Create detailed view
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Employee Information</h6>
                <table class="table table-sm">
                    <tr><td>Name:</td><td><strong>${name}</strong></td></tr>
                    <tr><td>Company:</td><td>${company}</td></tr>
                    <tr><td>Hourly Rate:</td><td>${hourlyRate}</td></tr>
                    <tr><td>Period:</td><td>${month} ${year}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Salary Breakdown</h6>
                <table class="table table-sm">
                    <tr><td>Basic Salary:</td><td class="text-success">₹${row.cells[7].textContent.replace('₹', '') || '0.00'}</td></tr>
                    <tr><td>Overtime Pay:</td><td class="text-warning">₹${row.cells[8].textContent.replace('₹', '') || '0.00'}</td></tr>
                    <tr><td>Deductions:</td><td class="text-danger">₹${row.cells[9].textContent.replace('₹', '') || '0.00'}</td></tr>
                    <tr><td><strong>Net Salary:</strong></td><td><strong class="text-primary">₹${row.cells[10].textContent.replace('₹', '') || '0.00'}</strong></td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Attendance Summary</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center py-2">
                                <h5 class="mb-0">${row.cells[4].querySelector('.progress-bar')?.textContent?.split('/')[0] || '0'}</h5>
                                <small>Present Days</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center py-2">
                                <h5 class="mb-0">${row.cells[4].querySelector('.progress-bar')?.textContent?.split('/')[1] || '0'}</h5>
                                <small>Total Days</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center py-2">
                                <h5 class="mb-0">${row.cells[5].textContent || '0h'}</h5>
                                <small>Working Hours</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center py-2">
                                <h5 class="mb-0">${row.cells[6].textContent || '0h'}</h5>
                                <small>Overtime</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('salaryDetailsContent').innerHTML = content;
    
    const modal = new bootstrap.Modal(document.getElementById('salaryDetailsModal'));
    modal.show();
}

function exportSalary() {
    const month = document.getElementById('monthFilter').value;
    const year = document.getElementById('yearFilter').value;
    const company = document.getElementById('companyFilter').value;
    
    let url = `/api/export_salary?month=${month}&year=${year}`;
    if (company) {
        url += `&company_id=${company}`;
    }
    
    window.open(url, '_blank');
}

function printSalary() {
    window.print();
}

// Calculate totals on page load
document.addEventListener('DOMContentLoaded', function() {
    calculateTotals();
});

function calculateTotals() {
    let totalSalary = 0, totalOvertime = 0, totalDeductions = 0;
    
    document.querySelectorAll('tbody tr').forEach(row => {
        const salary = parseFloat(row.cells[10].textContent.replace('₹', '')) || 0;
        const overtime = parseFloat(row.cells[8].textContent.replace('₹', '')) || 0;
        const deductions = parseFloat(row.cells[9].textContent.replace('₹', '')) || 0;
        
        totalSalary += salary;
        totalOvertime += overtime;
        totalDeductions += deductions;
    });
    
    document.getElementById('totalSalary').textContent = `₹${totalSalary.toFixed(2)}`;
    document.getElementById('totalOvertime').textContent = `₹${totalOvertime.toFixed(2)}`;
    document.getElementById('totalDeductions').textContent = `₹${totalDeductions.toFixed(2)}`;
}
</script>

<style>
.progress {
    background-color: #e9ecef;
}

.progress-bar {
    font-size: 0.75rem;
    line-height: 1.2;
}
</style>
{% endblock %}


